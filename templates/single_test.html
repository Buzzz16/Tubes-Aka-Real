{% extends "base.html" %}

{% block title %}Single Test - Pertumbuhan Bakteri{% endblock %}

{% block content %}
<div class="single-test-page">
    <!-- Hero Section -->
    <section class="hero-section fade-in">
        <div class="hero-content">
            <h1 class="page-title">
                <i class="fas fa-bacterium"></i>
                Single Input Analysis
            </h1>
            <p class="page-subtitle">
                Analisis pertumbuhan <em>Vibrio natriegens</em> untuk satu perhitungan
            </p>
        </div>
    </section>

    <!-- Input Form -->
    <section class="content-section glass-card slide-up" style="animation-delay: 0.2s">
        <div class="section-icon">
            <i class="fas fa-keyboard"></i>
        </div>
        <h2 class="section-title">Input Parameter Pertumbuhan Bakteri</h2>
        
        <form id="singleTestForm" class="test-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="n0">
                        <i class="fas fa-bacterium"></i>
                        Jumlah Awal Bakteri (N₀)
                    </label>
                    <input type="number" id="n0" name="n0" value="100" min="1" required class="form-input">
                    <small class="form-hint">Populasi awal bakteri (bilangan bulat positif)</small>
                </div>
                
                <div class="form-group">
                    <label for="tipe_pertumbuhan">
                        <i class="fas fa-dna"></i>
                        Tipe Pertumbuhan Bakteri
                    </label>
                    <select id="tipe_pertumbuhan" name="tipe_pertumbuhan" class="form-input" required>
                        <option value="1">Detik</option>
                        <option value="2" selected>Menit</option>
                        <option value="3">Jam</option>
                        <option value="4">Jumlah Kejadian</option>
                    </select>
                    <small class="form-hint">Satuan waktu untuk durasi pertumbuhan</small>
                </div>
                
                <div class="form-group">
                    <label for="durasi">
                        <i class="fas fa-hourglass-half"></i>
                        <span id="durasi_label">Nilai Durasi</span>
                    </label>
                    <input type="number" id="durasi" name="durasi" value="60" min="0" step="any" required class="form-input">
                    <small class="form-hint" id="durasi_hint">Durasi pertumbuhan sesuai tipe yang dipilih</small>
                </div>
                
                <div class="form-group" id="laju_group">
                    <label for="laju_pertumbuhan">
                        <i class="fas fa-tachometer-alt"></i>
                        Laju Pertumbuhan (menit)
                    </label>
                    <input type="number" id="laju_pertumbuhan" name="laju_pertumbuhan" value="10" min="0.1" step="any" class="form-input">
                    <small class="form-hint">Waktu per pembelahan (default: 10 menit untuk <em>V. natriegens</em>)</small>
                </div>
            </div>
            
            <button type="submit" class="submit-btn">
                <i class="fas fa-play-circle"></i>
                <span>Mulai Analisis Pertumbuhan</span>
            </button>
        </form>
    </section>

    <!-- Warning Alert -->
    <div id="warningAlert" class="alert-box warning-alert" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="warningText"></span>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <!-- Validation Status -->
        <section class="content-section glass-card slide-up">
            <div id="validationStatus"></div>
        </section>

        <!-- Result Display -->
        <section class="content-section glass-card result-display slide-up">
            <div class="section-icon">
                <i class="fas fa-microscope"></i>
            </div>
            <h3 class="section-title">Hasil Perhitungan Populasi Bakteri</h3>
            
            <div class="result-grid">
                <div class="result-item">
                    <h4>Populasi Awal (N₀)</h4>
                    <p id="inputN0" class="result-value">-</p>
                </div>
                <div class="result-item">
                    <h4>Durasi</h4>
                    <p id="inputDurasi" class="result-value">-</p>
                </div>
                <div class="result-item">
                    <h4>Laju Pertumbuhan</h4>
                    <p id="inputLaju" class="result-value">-</p>
                </div>
                <div class="result-item">
                    <h4>Jumlah Kejadian (x)</h4>
                    <p id="inputKejadian" class="result-value">-</p>
                </div>
                <div class="result-item full-width">
                    <h4>Populasi Akhir Bakteri</h4>
                    <p id="resultValue" class="result-value large">-</p>
                    <small class="result-info" id="resultInfo"></small>
                </div>
            </div>
        </section>

        <!-- Metrics Cards -->
        <section class="metrics-section slide-up">
            <div class="metrics-grid">
                <div class="metric-card glass-card recursive-card">
                    <div class="metric-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <h3 class="metric-title">Rekursif</h3>
                    <div class="metric-value" id="recursiveTime">-- ms</div>
                    <div class="metric-label">Waktu Eksekusi</div>
                </div>
                
                <div class="metric-card glass-card iterative-card">
                    <div class="metric-icon">
                        <i class="fas fa-repeat"></i>
                    </div>
                    <h3 class="metric-title">Iteratif</h3>
                    <div class="metric-value" id="iterativeTime">-- ms</div>
                    <div class="metric-label">Waktu Eksekusi</div>
                    <div class="metric-delta" id="timeDelta"></div>
                </div>
            </div>
        </section>

        <!-- Conclusion -->
        <section class="content-section glass-card conclusion-section slide-up">
            <div class="section-icon">
                <i class="fas fa-lightbulb"></i>
            </div>
            <h3 class="section-title">Kesimpulan</h3>
            <p class="conclusion-text" id="conclusionText"></p>
        </section>

        <!-- Chart Section -->
        <section class="content-section glass-card chart-section slide-up">
            <div class="section-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="section-header-with-actions">
                <h3 class="section-title">Visualisasi Perbandingan</h3>
                <button type="button" class="export-btn small" onclick="downloadChart('comparisonChart', 'bacteria-comparison')" title="Download Chart as PNG">
                    <i class="fas fa-image"></i>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    let comparisonChart = null;

    // Download chart as PNG
    window.downloadChart = function(chartId, filename) {
        const canvas = document.getElementById(chartId);
        if (!canvas || !comparisonChart) {
            alert('Chart belum tersedia. Silakan hitung terlebih dahulu.');
            return;
        }
        const link = document.createElement('a');
        link.download = filename + '-' + new Date().toISOString().slice(0,10) + '.png';
        link.href = comparisonChart.toBase64Image();
        link.click();
    };

    // Toggle laju_pertumbuhan visibility based on tipe_pertumbuhan
    const tipePertumbuhan = document.getElementById('tipe_pertumbuhan');
    if (tipePertumbuhan) {
        tipePertumbuhan.addEventListener('change', function() {
            const lajuGroup = document.getElementById('laju_group');
            const lajuInput = document.getElementById('laju_pertumbuhan');
            const durasiLabel = document.getElementById('durasi_label');
            const durasiHint = document.getElementById('durasi_hint');
            
            if (this.value === '4') { // Jumlah Kejadian
                lajuGroup.style.display = 'none';
                lajuInput.removeAttribute('required');
                durasiLabel.textContent = 'Jumlah Kejadian';
                durasiHint.textContent = 'Jumlah kejadian pembelahan bakteri';
            } else {
                lajuGroup.style.display = 'block';
                lajuInput.setAttribute('required', 'required');
                durasiLabel.textContent = 'Nilai Durasi';
                durasiHint.textContent = 'Durasi pertumbuhan sesuai tipe yang dipilih';
            }
        });
    }

    const singleTestForm = document.getElementById('singleTestForm');
    if (singleTestForm) {
        singleTestForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading
            document.getElementById('loadingOverlay').classList.add('active');
            
            // Hide previous results
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('warningAlert').style.display = 'none';
            
            // Get form data
            const formData = new FormData(this);
            
            try {
                const response = await fetch('{{ url_for("single_test") }}', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Hide loading
                document.getElementById('loadingOverlay').classList.remove('active');
                
                if (data.success) {
                    // Show warning if exists
                    if (data.warning) {
                        document.getElementById('warningAlert').style.display = 'flex';
                        document.getElementById('warningText').textContent = data.warning;
                    }
                    
                    // Show validation status
                    const validationStatus = document.getElementById('validationStatus');
                    if (data.recursion_error) {
                        validationStatus.innerHTML = `
                            <div class="status-box error-status">
                                <i class="fas fa-times-circle"></i>
                                <span>Rekursif mengalami RecursionError! Stack limit terlampaui.</span>
                            </div>
                        `;
                    } else if (data.valid) {
                        validationStatus.innerHTML = `
                            <div class="status-box success-status">
                                <i class="fas fa-check-circle"></i>
                                <span>Hasil perhitungan kedua algoritma valid dan identik.</span>
                            </div>
                        `;
                    } else {
                        validationStatus.innerHTML = `
                            <div class="status-box error-status">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Terjadi ketidakcocokan hasil!</span>
                            </div>
                        `;
                    }
                    
                    // Update metrics
                    document.getElementById('recursiveTime').textContent = 
                        data.time_rec ? data.time_rec.toFixed(6) + ' ms' : 'Error';
                    document.getElementById('iterativeTime').textContent = 
                        data.time_iter.toFixed(6) + ' ms';
                    
                    // Update input values
                    document.getElementById('inputN0').textContent = data.input_data.n0 + ' bakteri';
                    document.getElementById('inputDurasi').textContent = data.input_data.durasi + ' ' + data.input_data.satuan;
                    document.getElementById('inputLaju').textContent = data.input_data.laju + ' menit';
                    document.getElementById('inputKejadian').textContent = data.input_data.kejadian + ' kali pembelahan';
                    
                    // Display result
                    document.getElementById('resultValue').textContent = data.result_iter + ' bakteri';
                    if (data.result_iter.includes('...')) {
                        document.getElementById('resultInfo').textContent = 
                            `Nilai terlalu besar untuk ditampilkan, menampilkan 100 karakter pertama`;
                    } else {
                        document.getElementById('resultInfo').textContent = 
                            `${data.result_iter.length} digit`;
                    }
                    
                    if (data.time_rec) {
                        const delta = data.time_iter - data.time_rec;
                        const deltaEl = document.getElementById('timeDelta');
                        deltaEl.textContent = (delta > 0 ? '+' : '') + delta.toFixed(6) + ' ms';
                        deltaEl.className = 'metric-delta ' + (delta > 0 ? 'positive' : 'negative');
                    }
                    
                    // Update conclusion
                    document.getElementById('conclusionText').textContent = data.conclusion;
                    
                    // Create chart
                    createComparisonChart(data.time_rec || 0, data.time_iter);
                    
                    // Show results with animation
                    const resultsSection = document.getElementById('resultsSection');
                    resultsSection.style.display = 'block';
                    setTimeout(() => {
                        resultsSection.querySelectorAll('.slide-up').forEach((el, index) => {
                            el.style.animationDelay = (index * 0.1) + 's';
                            el.classList.add('animated');
                        });
                    }, 100);
                    
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                document.getElementById('loadingOverlay').classList.remove('active');
                alert('Terjadi kesalahan: ' + error.message);
            }
        });
    }

    function createComparisonChart(timeRec, timeIter) {
        const ctx = document.getElementById('comparisonChart');
        
        if (!ctx) return;
        if (comparisonChart) {
            comparisonChart.destroy();
        }
        
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Rekursif', 'Iteratif'],
                datasets: [{
                    label: 'Waktu Eksekusi (ms)',
                    data: [timeRec, timeIter],
                    backgroundColor: [
                        'rgba(139, 92, 246, 0.7)',
                        'rgba(16, 185, 129, 0.7)'
                    ],
                    borderColor: [
                        'rgba(139, 92, 246, 1)',
                        'rgba(16, 185, 129, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        padding: 12,
                        titleColor: '#1E293B',
                        bodyColor: '#475569',
                        borderColor: 'rgba(16, 185, 129, 0.3)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(6) + ' ms';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(100, 100, 100, 0.2)'
                        },
                        ticks: {
                            color: '#000000',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            callback: function(value) {
                                return value.toFixed(2) + ' ms';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#000000',
                            font: {
                                size: 15,
                                weight: 'bold'
                            }
                        }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                }
            }
        });
    }
});
</script>
{% endblock %}
