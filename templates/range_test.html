{% extends "base.html" %}

{% block title %}Multiple Test - Pertumbuhan Bakteri{% endblock %}

{% block content %}
<div class="range-test-page">
    <!-- Hero Section -->
    <section class="hero-section fade-in">
        <div class="hero-content">
            <h1 class="page-title">
                <i class="fas fa-vials"></i>
                Multiple Test
            </h1>
            <p class="page-subtitle">
                Analisis tren pertumbuhan bakteri pada berbagai durasi waktu
            </p>
        </div>
    </section>

    <!-- Input Form -->
    <section class="content-section glass-card slide-up" style="animation-delay: 0.2s">
        <div class="section-icon">
            <i class="fas fa-sliders-h"></i>
        </div>
        <h2 class="section-title">Konfigurasi Multiple Test Pertumbuhan Bakteri</h2>
        
        <form id="rangeTestForm" class="test-form">
            <div class="form-grid four-col">
                <div class="form-group">
                    <label for="n0">
                        <i class="fas fa-bacterium"></i>
                        Jumlah Awal Bakteri (Nâ‚€)
                    </label>
                    <input type="number" id="n0" name="n0" value="100" min="1" required class="form-input">
                    <small class="form-hint">Populasi awal bakteri</small>
                </div>
                
                <div class="form-group">
                    <label for="tipe_pertumbuhan">
                        <i class="fas fa-dna"></i>
                        Tipe Pertumbuhan Bakteri
                    </label>
                    <select id="tipe_pertumbuhan" name="tipe_pertumbuhan" class="form-input" required>
                        <option value="1">Detik</option>
                        <option value="2" selected>Menit</option>
                        <option value="3">Jam</option>
                        <option value="4">Jumlah Kejadian</option>
                    </select>
                    <small class="form-hint">Satuan untuk nilai mulai dan akhir</small>
                </div>
                
                <div class="form-group">
                    <label for="start_value">
                        <i class="fas fa-play"></i>
                        <span id="start_label">Nilai Mulai Pertumbuhan</span>
                    </label>
                    <input type="number" id="start_value" name="start_value" value="10" min="0" step="any" required class="form-input">
                    <small class="form-hint" id="start_hint">Nilai awal durasi pertumbuhan</small>
                </div>
                
                <div class="form-group">
                    <label for="end_value">
                        <i class="fas fa-stop"></i>
                        <span id="end_label">Nilai Akhir Pertumbuhan</span>
                    </label>
                    <input type="number" id="end_value" name="end_value" value="100" min="0" step="any" required class="form-input">
                    <small class="form-hint" id="end_hint">Nilai akhir durasi pertumbuhan</small>
                </div>

                <div class="form-group span-2" id="laju_group">
                    <label for="laju_pertumbuhan">
                        <i class="fas fa-tachometer-alt"></i>
                        Laju Pertumbuhan (menit)
                    </label>
                    <input type="number" id="laju_pertumbuhan" name="laju_pertumbuhan" value="10" min="0.1" step="any" class="form-input">
                    <small class="form-hint">Waktu per pembelahan (default: 10 menit)</small>
                </div>

                <div class="form-group span-2" id="interval_group">
                    <label for="interval">
                        <i class="fas fa-stream"></i>
                        Interval Kejadian
                    </label>
                    <input type="number" id="interval" name="interval" value="2" min="1" step="1" required class="form-input">
                    <small class="form-hint">Selisih antar kejadian pertumbuhan (contoh: interval 2 = kejadian 0, 2, 4, 6, ...)</small>
                </div>
            </div>
            
            <button type="submit" class="submit-btn">
                <i class="fas fa-chart-line"></i>
                <span>Generate Grafik & Analisis</span>
            </button>
        </form>
    </section>

    <!-- Progress Bar -->
    <div id="progressSection" class="progress-section" style="display: none;">
        <div class="glass-card progress-card">
            <h3><i class="fas fa-spinner fa-spin"></i> Memproses Data Pertumbuhan Bakteri...</h3>
            <p class="progress-info" id="progressInfo" style="margin: 0.5rem 0; color: #059669; font-size: 0.9rem;"></p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="progress-text" id="progressText">0%</p>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <!-- Chart Section -->
        <section class="content-section glass-card chart-section slide-up">
            <div class="section-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="section-title">1. Visualisasi Perbandingan (Line Chart)</h3>
            <div class="chart-container large">
                <canvas id="trendChart"></canvas>
            </div>
        </section>

        <!-- Statistics Section -->
        <section class="metrics-section slide-up">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <h3 class="section-title">2. Kesimpulan Analisis</h3>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card glass-card iterative-card">
                    <div class="metric-icon">
                        <i class="fas fa-repeat"></i>
                    </div>
                    <h4 class="metric-title">Rata-rata Iteratif</h4>
                    <div class="metric-value" id="avgIterative">-- ms</div>
                </div>
                
                <div class="metric-card glass-card recursive-card">
                    <div class="metric-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <h4 class="metric-title">Rata-rata Rekursif</h4>
                    <div class="metric-value" id="avgRecursive">-- ms</div>
                </div>
            </div>
            
            <div class="conclusion-box glass-card">
                <i class="fas fa-lightbulb"></i>
                <p id="rangeConclusion"></p>
            </div>
        </section>

        <!-- Data Table Section -->
        <section class="content-section glass-card table-section slide-up">
            <div class="section-icon">
                <i class="fas fa-table"></i>
            </div>
            <h3 class="section-title">3. Data Mentah</h3>
            <div class="table-container">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th id="durasi_header">Durasi</th>
                            <th>Kejadian (x)</th>
                            <th>Iteratif (ms)</th>
                            <th>Rekursif (ms)</th>
                            <th>Populasi Bakteri</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trendChart = null;

// Toggle laju_pertumbuhan visibility and durasi column based on tipe_pertumbuhan
document.getElementById('tipe_pertumbuhan').addEventListener('change', function() {
    const lajuGroup = document.getElementById('laju_group');
    const lajuInput = document.getElementById('laju_pertumbuhan');
    const intervalGroup = document.getElementById('interval_group');
    const startLabel = document.getElementById('start_label');
    const endLabel = document.getElementById('end_label');
    const startHint = document.getElementById('start_hint');
    const endHint = document.getElementById('end_hint');
    const durasiHeader = document.getElementById('durasi_header');
    
    if (this.value === '4') { // Jumlah Kejadian
        lajuGroup.style.display = 'none';
        lajuInput.removeAttribute('required');
        intervalGroup.classList.remove('span-2');
        intervalGroup.classList.add('span-4');
        startLabel.textContent = 'Kejadian Mulai';
        endLabel.textContent = 'Kejadian Akhir';
        startHint.textContent = 'Jumlah kejadian awal';
        endHint.textContent = 'Jumlah kejadian akhir';
        durasiHeader.style.display = 'none';
    } else {
        lajuGroup.style.display = 'block';
        lajuInput.setAttribute('required', 'required');
        intervalGroup.classList.remove('span-4');
        intervalGroup.classList.add('span-2');
        startLabel.textContent = 'Nilai Mulai Pertumbuhan';
        endLabel.textContent = 'Nilai Akhir Pertumbuhan';
        startHint.textContent = 'Nilai awal durasi pertumbuhan';
        endHint.textContent = 'Nilai akhir durasi pertumbuhan';
        durasiHeader.style.display = '';
    }
});

document.getElementById('rangeTestForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Validate inputs
    const startValue = parseFloat(document.getElementById('start_value').value);
    const endValue = parseFloat(document.getElementById('end_value').value);
    const interval = parseInt(document.getElementById('interval').value);
    
    if (startValue >= endValue) {
        alert('Nilai Akhir harus lebih besar dari Nilai Mulai');
        return;
    }
    
    if (interval <= 0) {
        alert('Interval harus lebih besar dari 0');
        return;
    }
    
    // Calculate estimated data points
    const laju = parseFloat(document.getElementById('laju_pertumbuhan').value) || 10;
    const tipe = document.getElementById('tipe_pertumbuhan').value;
    let estimatedPoints;
    if (tipe === '4') {
        estimatedPoints = Math.floor((endValue - startValue) / interval) + 1;
    } else {
        const kejadianMulai = Math.floor((startValue * 60) / (laju * 60));
        const kejadianAkhir = Math.floor((endValue * 60) / (laju * 60));
        estimatedPoints = Math.floor((kejadianAkhir - kejadianMulai) / interval) + 1;
    }
    
    // Show progress section with info
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('progressInfo').textContent = `Menghitung ${estimatedPoints} data points...`;
    
    // Simulate progress (since we can't get real-time updates from Flask easily)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        if (progress <= 90) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
        }
    }, 100);
    
    // Get form data
    const formData = new FormData(this);
    
    try {
        const response = await fetch('{{ url_for("range_test") }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Complete progress
        clearInterval(progressInterval);
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressText').textContent = '100%';
        
        setTimeout(() => {
            document.getElementById('progressSection').style.display = 'none';
        }, 500);
        
        if (data.success) {
            // Update statistics
            document.getElementById('avgIterative').textContent = 
                data.avg_iter.toFixed(6) + ' ms';
            document.getElementById('avgRecursive').textContent = 
                data.avg_rec ? data.avg_rec.toFixed(6) + ' ms' : 'N/A';
            document.getElementById('rangeConclusion').textContent = data.conclusion;
            
            // Create chart
            createTrendChart(data.data_points);
            
            // Populate table
            populateDataTable(data.data_points);
            
            // Show results with animation
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.style.display = 'block';
            setTimeout(() => {
                resultsSection.querySelectorAll('.slide-up').forEach((el, index) => {
                    el.style.animationDelay = (index * 0.1) + 's';
                    el.classList.add('animated');
                });
            }, 100);
            
        } else {
            alert('Error: ' + data.error);
        }
        
    } catch (error) {
        clearInterval(progressInterval);
        document.getElementById('progressSection').style.display = 'none';
        alert('Terjadi kesalahan: ' + error.message);
    }
});

function createTrendChart(dataPoints) {
    const ctx = document.getElementById('trendChart');
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    const labels = dataPoints.map(d => `${d.durasi} (${d.kejadian}x)`);
    const iterativeData = dataPoints.map(d => d.time_iter);
    const recursiveData = dataPoints.map(d => d.time_rec);
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Iteratif',
                    data: iterativeData,
                    borderColor: 'rgba(34, 197, 94, 1)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(34, 197, 94, 1)'
                },
                {
                    label: 'Rekursif',
                    data: recursiveData,
                    borderColor: 'rgba(139, 92, 246, 1)',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgba(139, 92, 246, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#CBD5E1',
                        font: {
                            size: 14,
                            weight: '600'
                        },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    padding: 12,
                    titleColor: '#1E293B',
                    bodyColor: '#475569',
                    borderColor: 'rgba(59, 130, 246, 0.3)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(6) + ' ms';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(148, 163, 184, 0.1)'
                    },
                    ticks: {
                        color: '#94A3B8',
                        callback: function(value) {
                            return value.toFixed(2) + ' ms';
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(148, 163, 184, 0.05)'
                    },
                    ticks: {
                        color: '#94A3B8',
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function populateDataTable(dataPoints) {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    
    const tipeValue = document.getElementById('tipe_pertumbuhan').value;
    const hideDurasi = (tipeValue === '4'); // Hide durasi column for "Jumlah Kejadian"
    
    dataPoints.forEach((point, index) => {
        const row = document.createElement('tr');
        row.style.animationDelay = (index * 0.02) + 's';
        
        if (hideDurasi) {
            row.innerHTML = `
                <td>${point.kejadian}</td>
                <td class="time-cell iterative">${point.time_iter.toFixed(6)}</td>
                <td class="time-cell recursive">${point.time_rec ? point.time_rec.toFixed(6) : 'N/A'}</td>
                <td class="result-cell" title="${point.result}">${point.result}</td>
            `;
        } else {
            row.innerHTML = `
                <td>${point.durasi}</td>
                <td>${point.kejadian}</td>
                <td class="time-cell iterative">${point.time_iter.toFixed(6)}</td>
                <td class="time-cell recursive">${point.time_rec ? point.time_rec.toFixed(6) : 'N/A'}</td>
                <td class="result-cell" title="${point.result}">${point.result}</td>
            `;
        }
        
        tbody.appendChild(row);
    });
}
</script>
{% endblock %}
